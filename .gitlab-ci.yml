stages:
  - test
  - build
  - deploy

variables:
  REGISTRY: "10.129.5.159:5050"
  IMAGE_NAME: "$REGISTRY/$CI_PROJECT_PATH/sae-test"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Stage de test - Lint et validation du code
lint_and_test:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install --no-cache-dir -r requirements.txt
  script:
    - echo "Execution des tests de linting..."
    - python run.py lint || echo "Linting completed avec warnings"
    - echo "Execution des tests unitaires..."
    - python run.py test --suite unit
    - echo "Tests terminés avec succès"
  only:
    - main
    - merge_requests

# Stage de build et push de l'image Docker
build_and_push:
  stage: build
  tags:
    - docker
  image: docker:24
  services:
    - docker:24-dind

  before_script:
    - until docker info; do sleep 1; done
    - echo "Connexion au registry Docker $REGISTRY..."
    # Authentification au registry GitLab
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $REGISTRY || echo "Registry login failed, trying without auth..."

  script:
    - echo "Build de l'image Docker..."
    - echo "Image complete - $IMAGE_NAME:$IMAGE_TAG"
    - docker build -t "$IMAGE_NAME:$IMAGE_TAG" -t "$IMAGE_NAME:latest" .
    - echo "Push de l'image avec le tag $IMAGE_TAG"
    - docker push "$IMAGE_NAME:$IMAGE_TAG" || echo "Push with tag failed"
    - echo "Push de l'image avec le tag latest"
    - docker push "$IMAGE_NAME:latest" || echo "Push with latest failed"
    - echo "Images buildees et pushees avec succes"

  only:
    - main

# Stage de déploiement sur Kubernetes (k3s)
deploy_to_k3s:
  stage: deploy
  tags:
    - docker
  image: alpine/k8s:1.28.3

  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config || echo "KUBECONFIG_CONTENT not set"
    - chmod 600 ~/.kube/config || echo "Kubeconfig not configured"

  script:
    - echo "Deploiement sur k3s..."
    - echo "Image a deployer - $IMAGE_NAME:latest"
    - kubectl get nodes || echo "Cannot connect to cluster"
    - kubectl apply -f kubernetes/namespace.yaml || echo "Namespace already exists"
    - kubectl apply -f kubernetes/deployment.yaml
    - kubectl apply -f kubernetes/service.yaml
    - kubectl set image deployment/sae-app sae-app=$IMAGE_NAME:latest -n sae-production
    - kubectl rollout status deployment/sae-app -n sae-production --timeout=5m || echo "Rollout timeout"
    - echo "Deploiement termine"
    - kubectl get pods -n sae-production

  only:
    - main
  when: manual  # Déploiement manuel pour plus de contrôle
